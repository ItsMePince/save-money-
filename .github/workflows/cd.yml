name: CD Pipeline

on:
  push:
    branches:
      - supawich

jobs:
  build_and_push:
    name: Build & Push Docker Images
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Docker Login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Build backend image from ./backend/Dockerfile
      - name: Build Backend Image
        run: |
          docker build \
            -t ${{ secrets.DOCKER_USERNAME }}/my-finapp-backend:latest \
            ./backend

      # Build frontend image from ./frontend/Dockerfile
      - name: Build Frontend Image
        run: |
          docker build \
            -t ${{ secrets.DOCKER_USERNAME }}/my-finapp-frontend:latest \
            ./frontend

      # Push images to Docker Hub
      - name: Push Backend Image
        run: docker push ${{ secrets.DOCKER_USERNAME }}/my-finapp-backend:latest

      - name: Push Frontend Image
        run: docker push ${{ secrets.DOCKER_USERNAME }}/my-finapp-frontend:latest

  deploy:
    name: Apply deploy.yaml to Kubernetes
    runs-on: ubuntu-latest
    needs: build_and_push

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "latest"

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" > ~/.kube/config

      - name: Apply Kubernetes manifests
        run: |
          # ใช้ไฟล์ที่อยู่ใน root ของ repo
          kubectl apply -f deploy.yaml
          kubectl apply -f ingress.yaml

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/backend-deployment
          kubectl rollout status deployment/frontend-deployment
