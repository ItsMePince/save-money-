name: CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  # ─────────────────────────────────────────────
  # 1) BACKEND: Build Spring Boot JAR
  # ─────────────────────────────────────────────
  backend_build:
    name: Backend • Build app
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Build backend with Maven
        working-directory: backend
        run: |
          chmod +x mvnw
          ./mvnw -B -DskipTests clean package

  # ─────────────────────────────────────────────
  # 2) BACKEND: Build & Push Docker image
  # ─────────────────────────────────────────────
  backend_docker:
    name: Backend • Build & push image
    runs-on: ubuntu-latest
    needs: backend_build

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Docker Login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build backend image
        run: |
          docker build \
            -t ${{ secrets.DOCKER_USERNAME }}/my-finapp-backend:latest \
            ./backend

      - name: Push backend image
        run: docker push ${{ secrets.DOCKER_USERNAME }}/my-finapp-backend:latest

  # ─────────────────────────────────────────────
  # 3) FRONTEND: Build Vite app
  # ─────────────────────────────────────────────
  frontend_build:
    name: Frontend • Build app
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend (Vite)
        working-directory: frontend
        run: npm run build

  # ─────────────────────────────────────────────
  # 4) FRONTEND: Build & Push Docker image
  # ─────────────────────────────────────────────
  frontend_docker:
    name: Frontend • Build & push image
    runs-on: ubuntu-latest
    needs: frontend_build

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Docker Login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build frontend image
        run: |
          docker build \
            -t ${{ secrets.DOCKER_USERNAME }}/my-finapp-frontend:latest \
            ./frontend

      - name: Push frontend image
        run: docker push ${{ secrets.DOCKER_USERNAME }}/my-finapp-frontend:latest

  # ─────────────────────────────────────────────
  # 5) DEPLOY: ใช้ภาพจาก Docker Hub ลง Docker Desktop Kubernetes
  # ─────────────────────────────────────────────
  deploy:
    name: Deploy • Apply manifests to k8s
    runs-on: self-hosted
    needs:
      - backend_docker
      - frontend_docker

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check kubectl context
        run: |
          kubectl config current-context
          kubectl get nodes

      - name: Apply Kubernetes manifests
        run: |
          kubectl apply -f deploy.yaml
          kubectl apply -f ingress.yaml

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/backend-deployment
          kubectl rollout status deployment/frontend-deployment
